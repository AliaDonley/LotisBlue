##using mapdamage on aligned reads to assess if aDNA is legit or contaminated. Data needs to be filtered before before 
##being run through md to eliminate noise. Using mapfork to parrellelize in perl script


NEED TO FILTER OFF ENDS FIRSt


cp FilterFork.pl /scratch/general/nfs1/u6000989/LycLotis/



file="/scratch/general/nfs1/u6000989/LycLotis/dedup_BAT20.bam"
output="/scratch/general/nfs1/u6000989/LycLotis/filtered_dedup_BAT20.bam"
samtools view -h "$file" | awk 'length($10) >= 50 || $1 ~ /^@/' | samtools view -Sb - > "$output"
            ###samtools view h file- for the computer to read the file and h ensures the header of the bam is included in the output
            ###| awk 'length($10) >= 50 || $1 ~ /^@/' | pipeline (output is used as next input)
            ### 10 is the 10th field (sequence of the read in this case, aligned to the reference) and checking for reads larger than 50bp
            ###  $1 ~ /^@/'- keeps all lines that start with @ (headers) in sam file. ^@ ensures header info is preserved
module load samtools
perl FilterFork.pl dedup_*bam

MapDamFork.pl
#!/usr/bin/perl
#
# run mapdamage
#
perl MapDamFork.pl *filtered_*.bamjob

use Parallel::ForkManager;
my $max = 12;
my $pm = Parallel::ForkManager->new($max);

foreach $file (@ARGV){
        $pm->start and next; ## fork
        $file =~ m/_([a-zA-Z0-9]+)\.bam/;
        $id = $1;
        $out = "output_$id"."_result";
        print "mapDamage -i $file -r ~/../gompert-group3/data/LmelGenome/Lmel_dovetailPacBio_genome.fasta -d $out\n";
        system "mapDamage -i $file -r ~/../gompert-group3/data/LmelGenome/Lmel_dovetailPacBio_genome.fasta -d $out\n";
        $pm->finish;
}
$pm->wait_all_children;


then:

#!/bin/sh
#SBATCH --time=72:00:00
#SBATCH --nodes=1
#SBATCH --ntasks=20
#SBATCH --account=gompert
#SBATCH --partition=kingspeak
#SBATCH --job-name=Lotismapdamagefiltered
#SBATCH --mail-type=FAIL
#SBATCH --mail-user=alia.donley@usu.edu

cd /uufs/chpc.utah.edu/common/home/u6047808/LycLotis/00_Alignment/01_mapdamage

perl MapDamFork.pl /scratch/general/nfs1/u6000989/LycLotis/*bam







